- name: DEFAULTS
  group: data-tests
  working_dir: nightly_tests/dataset

  frequency: nightly
  team: data

  cluster:
    byod:
      # 'type: gpu' means: use the 'ray-ml' image.
      type: gpu
    cluster_compute: autoscaling_cpu_compute.yaml

###############
# Reading tests
###############

- name: read_parquet
  run:
    timeout: 86400
    script: >
      python read_and_consume_benchmark.py
      s3://ray-benchmark-data-internal/imagenet/parquet --format parquet
      --iter-bundles

- name: read_images
  run:
    timeout: 86400
    script: >
      python read_and_consume_benchmark.py
      s3://anyscale-imagenet/ILSVRC/Data/CLS-LOC/ --format image --iter-bundles

- name: read_tfrecords
  run:
    timeout: 86400
    script: >
      python read_and_consume_benchmark.py
      s3://ray-benchmark-data-internal/imagenet/tfrecords --format tfrecords
      --iter-bundles

- name: read_from_uris
  run:
    timeout: 86400
    script: python read_from_uris_benchmark.py

###############
# Writing tests
###############

- name: write_parquet
  run:
    timeout: 86400
    script: >
      python read_and_consume_benchmark.py
      s3://ray-benchmark-data/tpch/parquet/sf1000/lineitem --format parquet --write

###########
# Map tests
###########

- name: map
  run:
    timeout: 86400
    script: python map_benchmark.py --api map --sf 10

- name: flat_map
  run:
    timeout: 86400
    script: python map_benchmark.py --api flat_map --sf 10

- name: map_batches
  run:
    timeout: 86400

  variations:
    - __suffix__: numpy
      # FIXME: Investigate why this is slow and OOMs.
      run:
        script: >
          python map_benchmark.py --api map_batches --batch-format numpy --sf 1000
    - __suffix__: pandas
      run:
        script: >
          python map_benchmark.py --api map_batches --batch-format pandas --sf 1000
    - __suffix__: pyarrow
      run:
        script: >
          python map_benchmark.py --api map_batches --batch-format pyarrow --sf 1000
    - __suffix__: actors
      run:
        script: >
          python map_benchmark.py --api map_batches --compute actors --sf 1000

#######################
# Batch inference tests
#######################

- name: batch_inference

  cluster:
    cluster_compute: autoscaling_hetero_compute_large.yaml

  run:
    timeout: 86400
    script: python batch_inference_benchmark.py --sf 100
